<script>
// Configuration - Updated with better error handling
const SCRAPER_ENDPOINT = 'https://madmac.netlify.app/.netlify/functions/fetchMadMacVideos';
let videoCache = { recent: [], popular: [] };

async function fetchVideos() {
  try {
    // Add cache-busting parameter to avoid stale responses
    const response = await fetch(`${SCRAPER_ENDPOINT}?t=${Date.now()}`);
    
    // First check if the response exists
    if (!response) {
      throw new Error('No response from server');
    }
    
    // Then check if the response is OK (status 200-299)
    if (!response.ok) {
      // Try to get error details from response
      let errorDetails = '';
      try {
        const errorData = await response.json();
        errorDetails = errorData.error || errorData.message || '';
      } catch (e) {}
      
      throw new Error(`Server error: ${response.status} ${response.statusText} ${errorDetails}`);
    }
    
    // Try to parse the response
    let data;
    try {
      data = await response.json();
    } catch (e) {
      throw new Error('Invalid JSON response');
    }
    
    // Handle different response formats
    if (Array.isArray(data)) {
      return {
        recent: data.slice(0, 6),
        popular: [...data].sort(() => 0.5 - Math.random()).slice(0, 6)
      };
    }
    
    if (data.error) {
      throw new Error(data.error);
    }
    
    if (!data.recent || !data.popular) {
      throw new Error('Unexpected response format');
    }
    
    return data;
    
  } catch (error) {
    console.error('Fetch error:', error);
    throw error;
  }
}

async function loadAllVideos() {
  const container = document.getElementById('videoList');
  
  try {
    container.innerHTML = '<div class="loading">Loading videos...</div>';
    
    // Add timeout to prevent hanging
    const timeoutPromise = new Promise((_, reject) => 
      setTimeout(() => reject(new Error('Request timed out')), 10000)
    );
    
    const videos = await Promise.race([fetchVideos(), timeoutPromise]);
    
    videoCache = {
      recent: videos.recent || [],
      popular: videos.popular || []
    };
    
    loadVideos('recent');
    
  } catch (error) {
    console.error('Load error:', error);
    
    // More detailed error messages
    let errorMessage = 'Failed to load videos';
    if (error.message.includes('timed out')) {
      errorMessage = 'Server is taking too long to respond';
    } else if (error.message.includes('JSON')) {
      errorMessage = 'Received invalid data from server';
    } else if (error.message.includes('404')) {
      errorMessage = 'Scraper endpoint not found';
    } else if (error.message.includes('CORS')) {
      errorMessage = 'Cross-origin request blocked';
    }
    
    container.innerHTML = `
      <div class="error">
        ${errorMessage}<br>
        <small>${error.message}</small><br>
        <button class="retry-btn" onclick="loadAllVideos()">Retry</button>
      </div>
    `;
  }
}

// Rest of your code remains the same...
</script>
